---
- name: Upgrade All Packages To The Latest Version
  ansible.builtin.apt:
    update_cache: true
    upgrade: true

- name: Install Core Dependencies, Clean APT, & Remove Old Programs
  apt:
    name: "{{ item }}"
    state: present
    install_recommends: true
    autoremove: true
    autoclean: true
  loop:
    - apt-transport-https
    - ca-certificates
    - cloud-init
    - curl
    - gnupg-agent
    - htop
    - linux-headers-amd64
    - linux-image-amd64
    - ncdu
    - sudo
    - tmux
    - unattended-upgrades
    - wget

- name: Set APT periodic update settings
  copy:
    dest: /etc/apt/apt.conf.d/10periodic
    content: |
      APT::Periodic::Update-Package-Lists "1";
      APT::Periodic::Unattended-Upgrade "1";
    owner: root
    group: root
    mode: '0644'

- name: Update Debian Repos as per Debian13 Errata (https://www.debian.org/releases/stable/errata)
  become: true
  become_method: sudo
  become_flags: "su -c"
  ansible.builtin.shell:
    cmd: |
      sudo sh -c 'echo "deb https://deb.debian.org/debian trixie-proposed-updates main contrib non-free" >> /etc/apt/sources.list'


- name: Upgrade All Packages To The Latest Version, after Debian13 Errata repos are added.
  ansible.builtin.apt:
    update_cache: true
    upgrade: true


- name: Wait until no process is locking dpkg, and all updates are complete.
  ansible.builtin.shell: |
    ! sudo fuser /var/lib/dpkg/lock > /dev/null 2>&1
  register: lock_check
  retries: 60
  delay: 2
  until: lock_check.rc == 0
